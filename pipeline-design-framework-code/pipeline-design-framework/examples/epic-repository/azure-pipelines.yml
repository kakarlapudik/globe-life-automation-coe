# Epic Repository Pipeline Configuration
# References the Pipeline Design Framework templates
# Version: 1.0.0

trigger:
  branches:
    include:
      - main
      - develop
  paths:
    exclude:
      - README.md
      - docs/**

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: 'epic-deployment-variables'

resources:
  repositories:
    - repository: pipeline-framework
      type: git
      name: 'Pipeline-Design-Framework'
      ref: 'refs/heads/main'

stages:
  # Security Scanning Stage
  - stage: SecurityScan
    displayName: 'Security Scanning'
    condition: and(succeeded(), eq(variables['Build.Reason'], 'PullRequest'))
    jobs:
      - template: azure-pipelines/security-scan-template.yml@pipeline-framework
        parameters:
          checkmarxTeam: $(CHECKMARX_TEAM)
          checkmarxProject: 'Epic-TestAutomation'
          sourceDirectory: './'
          excludePatterns: '*.min.js,node_modules/**,*.log,venv/**,__pycache__/**'
          enableSonarQube: true
          sonarQubeConnection: $(SONARQUBE_CONNECTION)

  # Infrastructure Deployment Stage
  - stage: DeployInfrastructure
    displayName: 'Deploy Epic Infrastructure'
    dependsOn: []
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - template: azure-pipelines/cdk-deploy-template.yml@pipeline-framework
        parameters:
          appName: $(APP_NAME)
          stackId: $(STACK_ID)
          appDir: $(APP_DIRECTORY)
          permissionsBoundary: $(PERMISSIONS_BOUNDARY)
          awsServiceConnection: $(AWS_SERVICE_CONNECTION)
          platform: $(PLATFORM)
          nodeVersion: '20'
          cdkDefaultRegion: $(CDK_DEFAULT_REGION)
          actionType: 'deploy'
          approvalNotification: $(APPROVAL_SNS_TOPIC)

  # Test Environment Validation
  - stage: ValidateDeployment
    displayName: 'Validate Epic Deployment'
    dependsOn: DeployInfrastructure
    condition: succeeded()
    jobs:
      - job: ValidationTests
        displayName: 'Run Epic Validation Tests'
        steps:
          - checkout: self
          
          - task: UsePythonVersion@0
            displayName: 'Setup Python 3.9'
            inputs:
              versionSpec: '3.9'
              addToPath: true
          
          - script: |
              pip install -r requirements-test.txt
            displayName: 'Install Test Dependencies'
          
          - task: AWSShellScript@1
            displayName: 'Validate Epic Infrastructure'
            inputs:
              awsCredentials: $(AWS_SERVICE_CONNECTION)
              regionName: $(CDK_DEFAULT_REGION)
              scriptType: 'inline'
              inlineScript: |
                echo "Validating Epic infrastructure deployment..."
                
                # Check if Epic stacks are deployed
                EPIC_STACK="${APP_NAME}-${STACK_ID}"
                echo "Checking stack: $EPIC_STACK"
                
                STACK_STATUS=$(aws cloudformation describe-stacks \
                  --stack-name "$EPIC_STACK" \
                  --query "Stacks[0].StackStatus" \
                  --output text 2>/dev/null || echo "NOT_FOUND")
                
                if [ "$STACK_STATUS" = "CREATE_COMPLETE" ] || [ "$STACK_STATUS" = "UPDATE_COMPLETE" ]; then
                  echo "✅ Epic infrastructure deployed successfully"
                  
                  # Get stack outputs
                  echo "Stack outputs:"
                  aws cloudformation describe-stacks \
                    --stack-name "$EPIC_STACK" \
                    --query "Stacks[0].Outputs" \
                    --output table
                else
                  echo "❌ Epic infrastructure deployment failed: $STACK_STATUS"
                  exit 1
                fi
          
          - script: |
              python -m pytest tests/integration/ -v --junitxml=test-results.xml
            displayName: 'Run Epic Integration Tests'
            continueOnError: true
          
          - task: PublishTestResults@2
            displayName: 'Publish Test Results'
            condition: always()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: 'test-results.xml'
              testRunTitle: 'Epic Integration Tests'

  # Cleanup Stage (for feature branches)
  - stage: Cleanup
    displayName: 'Cleanup Epic Resources'
    dependsOn: []
    condition: and(always(), ne(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - job: ManualApproval
        displayName: 'Manual Approval for Cleanup'
        pool: server
        timeoutInMinutes: 1440 # 24 hours
        steps:
          - task: ManualValidation@0
            displayName: 'Approve Resource Cleanup'
            inputs:
              notifyUsers: $(EPIC_TEAM_EMAIL)
              instructions: 'Please approve cleanup of Epic test resources'
      
      - job: CleanupResources
        displayName: 'Cleanup Epic Test Resources'
        dependsOn: ManualApproval
        steps:
          - template: azure-pipelines/cdk-deploy-template.yml@pipeline-framework
            parameters:
              appName: $(APP_NAME)
              stackId: '$(STACK_ID)-$(Build.BuildId)'
              appDir: $(APP_DIRECTORY)
              permissionsBoundary: $(PERMISSIONS_BOUNDARY)
              awsServiceConnection: $(AWS_SERVICE_CONNECTION)
              platform: $(PLATFORM)
              actionType: 'destroy'
