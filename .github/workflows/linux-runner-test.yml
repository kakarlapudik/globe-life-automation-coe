name: Test on GitHub Linux Runner

on:
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Test execution mode'
        required: true
        default: 'local-playwright'
        type: choice
        options:
        - local-playwright
        - mock-selenium-grid
        - connectivity-test

jobs:
  linux-runner-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
        # Install Playwright for local testing
        playwright install chromium --with-deps
    
    - name: Test Grid Connectivity
      run: |
        echo "ðŸ” Testing connectivity to Selenium Grid..."
        
        # Test if grid is accessible (will likely fail from GitHub runner)
        if curl -f --connect-timeout 5 --max-time 10 http://192.168.1.33:4444/wd/hub/status; then
          echo "âœ… Selenium Grid is accessible from GitHub runner"
          echo "GRID_ACCESSIBLE=true" >> $GITHUB_ENV
        else
          echo "âŒ Selenium Grid is not accessible from GitHub runner"
          echo "This is expected for private networks"
          echo "GRID_ACCESSIBLE=false" >> $GITHUB_ENV
        fi
    
    - name: Run Tests Based on Connectivity
      run: |
        case "${{ github.event.inputs.test_mode }}" in
          "local-playwright")
            echo "ðŸŽ­ Running tests with local Playwright (no grid)"
            # Disable Selenium Grid, use local Playwright
            unset USE_SELENIUM_GRID
            pytest generated_tests/test_homepage_links.py -v -s \
              --html=reports/linux_local_playwright.html \
              --self-contained-html
            ;;
          "mock-selenium-grid")
            echo "ðŸ§ª Running with mock Selenium Grid setup"
            # Set up a local Selenium Grid for testing
            docker run -d -p 4444:4444 --name selenium-hub selenium/hub:latest || echo "Docker not available"
            sleep 10
            
            # Try to use local grid
            export USE_SELENIUM_GRID=true
            export SELENIUM_HUB_URL=http://localhost:4444
            python test_selenium_grid_connectivity.py || echo "Local grid test completed"
            ;;
          "connectivity-test")
            echo "ðŸ”— Running connectivity tests only"
            python test_selenium_grid_connectivity.py || echo "Connectivity test completed"
            ;;
        esac
    
    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: linux-runner-results
        path: |
          reports/
          screenshots/