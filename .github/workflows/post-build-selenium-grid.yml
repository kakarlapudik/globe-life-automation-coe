name: Post-Build Selenium Grid Testing

on:
  # Trigger after any successful workflow completion
  workflow_run:
    workflows: ["Test Suite", "Comprehensive Test Suite"]
    types: [completed]
    branches: [main, develop, feature/*]
  
  # Manual dispatch for on-demand testing
  workflow_dispatch:
    inputs:
      grid_hub_url:
        description: 'Selenium Grid Hub URL'
        required: false
        default: 'http://192.168.1.33:4444'
        type: string
      test_target:
        description: 'Test target to run'
        required: true
        default: 'homepage-links'
        type: choice
        options:
        - homepage-links
        - full-automation-suite
        - selenium-grid-validation
        - all-tests
      browser_matrix:
        description: 'Browsers to test'
        required: true
        default: 'chrome'
        type: choice
        options:
        - chrome
        - firefox
        - both
      parallel_execution:
        description: 'Enable parallel execution'
        required: false
        default: true
        type: boolean

env:
  SELENIUM_HUB_URL: ${{ github.event.inputs.grid_hub_url || 'http://192.168.1.33:4444' }}
  USE_SELENIUM_GRID: true
  PYTHONHTTPSVERIFY: 0

jobs:
  # Pre-flight checks
  preflight:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    outputs:
      grid-available: ${{ steps.grid-check.outputs.available }}
      browsers: ${{ steps.browser-matrix.outputs.browsers }}
    
    steps:
    - name: Check Selenium Grid availability
      id: grid-check
      run: |
        echo "ðŸ” Checking Selenium Grid availability..."
        
        if curl -f --connect-timeout 10 --max-time 30 "$SELENIUM_HUB_URL/wd/hub/status" > /dev/null 2>&1; then
          echo "âœ… Selenium Grid is available at $SELENIUM_HUB_URL"
          echo "available=true" >> $GITHUB_OUTPUT
          
          # Get grid status details
          curl -s "$SELENIUM_HUB_URL/wd/hub/status" | jq -r '.value.ready' || echo "Grid status check completed"
        else
          echo "âŒ Selenium Grid is not available at $SELENIUM_HUB_URL"
          echo "âš ï¸ Grid tests will be skipped"
          echo "available=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Determine browser matrix
      id: browser-matrix
      run: |
        BROWSER_INPUT="${{ github.event.inputs.browser_matrix || 'chrome' }}"
        
        case "$BROWSER_INPUT" in
          "both")
            echo "browsers=[\"chrome\", \"firefox\"]" >> $GITHUB_OUTPUT
            ;;
          "firefox")
            echo "browsers=[\"firefox\"]" >> $GITHUB_OUTPUT
            ;;
          *)
            echo "browsers=[\"chrome\"]" >> $GITHUB_OUTPUT
            ;;
        esac
        
        echo "ðŸŒ Browser matrix: $BROWSER_INPUT"

  # Main Selenium Grid testing job
  selenium-grid-tests:
    needs: preflight
    if: needs.preflight.outputs.grid-available == 'true'
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        browser: ${{ fromJson(needs.preflight.outputs.browsers) }}
        python-version: ['3.11']
      fail-fast: false
      max-parallel: 2
    
    env:
      SELENIUM_BROWSER: ${{ matrix.browser }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Cache Python dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-selenium-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-selenium-
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
        # Install Selenium-specific dependencies
        pip install selenium==4.15.2 webdriver-manager==4.0.1
        
        echo "ðŸ“¦ Dependencies installed successfully"
    
    - name: Verify Grid connection
      run: |
        echo "ðŸ”— Verifying connection to Selenium Grid..."
        echo "Hub URL: $SELENIUM_HUB_URL"
        echo "Browser: $SELENIUM_BROWSER"
        
        # Test grid status
        curl -f "$SELENIUM_HUB_URL/wd/hub/status" | jq -r '.value.message' || echo "Grid connection verified"
    
    - name: Run Selenium Grid Tests
      run: |
        echo "ðŸš€ Starting Selenium Grid test execution..."
        echo "Target: ${{ github.event.inputs.test_target || 'homepage-links' }}"
        
        # Create reports directory
        mkdir -p reports screenshots
        
        # Determine test execution based on target
        TEST_TARGET="${{ github.event.inputs.test_target || 'homepage-links' }}"
        PARALLEL_FLAG=""
        
        if [ "${{ github.event.inputs.parallel_execution || 'true' }}" == "true" ]; then
          PARALLEL_FLAG="-n 2 --dist worksteal"
        fi
        
        case "$TEST_TARGET" in
          "homepage-links")
            pytest test_selenium_grid_uc001.py -v -s \
              --html=reports/selenium_grid_homepage_${{ matrix.browser }}.html \
              --self-contained-html \
              --junit-xml=reports/selenium_grid_junit_${{ matrix.browser }}.xml \
              $PARALLEL_FLAG
            ;;
          "full-automation-suite")
            # Set environment for full automation
            export USE_SELENIUM_GRID=true
            python run_complete_automation.py
            ;;
          "selenium-grid-validation")
            pytest test_selenium_grid_uc001.py -v -s \
              --html=reports/selenium_grid_validation_${{ matrix.browser }}.html \
              --self-contained-html \
              $PARALLEL_FLAG
            ;;
          "all-tests")
            # Run both Selenium Grid and generated tests
            pytest test_selenium_grid_uc001.py final_automation/generated_tests/ -v -s \
              --html=reports/selenium_grid_all_${{ matrix.browser }}.html \
              --self-contained-html \
              --junit-xml=reports/selenium_grid_all_junit_${{ matrix.browser }}.xml \
              $PARALLEL_FLAG
            ;;
        esac
      continue-on-error: true
    
    - name: Process Test Results
      if: always()
      run: |
        echo "ðŸ“Š Processing test results for ${{ matrix.browser }}..."
        
        # Generate summary
        echo "## Selenium Grid Test Results - ${{ matrix.browser }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Grid Hub**: $SELENIUM_HUB_URL" >> $GITHUB_STEP_SUMMARY
        echo "- **Browser**: ${{ matrix.browser }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Test Target**: ${{ github.event.inputs.test_target || 'homepage-links' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Parallel Execution**: ${{ github.event.inputs.parallel_execution || 'true' }}" >> $GITHUB_STEP_SUMMARY
        
        # Check for JSON reports and extract metrics
        if [ -f "reports/selenium_grid_uc001_links_report.json" ]; then
          echo "âœ… Test execution completed" >> $GITHUB_STEP_SUMMARY
          
          # Extract key metrics
          if command -v jq > /dev/null; then
            TOTAL=$(jq -r '.total_links // "N/A"' reports/selenium_grid_uc001_links_report.json)
            VALID=$(jq -r '.valid_links_count // "N/A"' reports/selenium_grid_uc001_links_report.json)
            BROKEN=$(jq -r '.broken_links_count // "N/A"' reports/selenium_grid_uc001_links_report.json)
            RATE=$(jq -r '.summary.success_rate // "N/A"' reports/selenium_grid_uc001_links_report.json)
            
            echo "- **Total Links**: $TOTAL" >> $GITHUB_STEP_SUMMARY
            echo "- **Valid Links**: $VALID" >> $GITHUB_STEP_SUMMARY
            echo "- **Broken Links**: $BROKEN" >> $GITHUB_STEP_SUMMARY
            echo "- **Success Rate**: $RATE" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "âš ï¸ No test reports found" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
    
    - name: Upload Test Artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: selenium-grid-results-${{ matrix.browser }}
        path: |
          reports/selenium_grid_*.html
          reports/selenium_grid_*.json
          reports/selenium_grid_*.xml
          reports/*screenshot*.png
          screenshots/
        retention-days: 30
    
    - name: Upload Failure Screenshots
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: selenium-grid-failures-${{ matrix.browser }}
        path: |
          reports/*failure*.png
          screenshots/*failure*
        retention-days: 7

  # Consolidate results and notify
  results-summary:
    needs: [preflight, selenium-grid-tests]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Generate Final Summary
      run: |
        echo "# ðŸŽ¯ Post-Build Selenium Grid Test Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.preflight.outputs.grid-available }}" == "true" ]; then
          echo "âœ… **Grid Status**: Available at $SELENIUM_HUB_URL" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.selenium-grid-tests.result }}" == "success" ]; then
            echo "âœ… **Test Results**: All tests passed successfully" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.selenium-grid-tests.result }}" == "failure" ]; then
            echo "âŒ **Test Results**: Some tests failed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Test Results**: Tests completed with warnings" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "âŒ **Grid Status**: Not available - tests skipped" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“Š **Execution Details**:" >> $GITHUB_STEP_SUMMARY
        echo "- Triggered by: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- Grid Hub: $SELENIUM_HUB_URL" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”— **Useful Links**:" >> $GITHUB_STEP_SUMMARY
        echo "- [Grid Console]($SELENIUM_HUB_URL/grid/console)" >> $GITHUB_STEP_SUMMARY
        echo "- [Test Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY

  # Skip notification if grid is not available
  grid-unavailable:
    needs: preflight
    runs-on: ubuntu-latest
    if: needs.preflight.outputs.grid-available == 'false'
    
    steps:
    - name: Grid Unavailable Notice
      run: |
        echo "# âš ï¸ Selenium Grid Unavailable" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "The Selenium Grid at $SELENIUM_HUB_URL is not accessible." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Possible causes:**" >> $GITHUB_STEP_SUMMARY
        echo "- Grid hub is not running" >> $GITHUB_STEP_SUMMARY
        echo "- Network connectivity issues" >> $GITHUB_STEP_SUMMARY
        echo "- Firewall blocking access" >> $GITHUB_STEP_SUMMARY
        echo "- Grid hub URL is incorrect" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Next steps:**" >> $GITHUB_STEP_SUMMARY
        echo "1. Verify grid is running: \`docker ps\` or check grid console" >> $GITHUB_STEP_SUMMARY
        echo "2. Test connectivity: \`curl $SELENIUM_HUB_URL/wd/hub/status\`" >> $GITHUB_STEP_SUMMARY
        echo "3. Re-run workflow once grid is available" >> $GITHUB_STEP_SUMMARY